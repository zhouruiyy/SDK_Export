name: Build Enhanced SDK

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'åŽŸå§‹ SDK ä¸‹è½½é“¾æŽ¥'
        required: true
        type: string
      sdk_version:
        description: 'SDK ç‰ˆæœ¬å·ï¼ˆå¦‚: 4.4.32.150ï¼‰'
        required: true
        type: string
      platform:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        type: choice
        options:
          - linux
          - mac

jobs:
  build:
    runs-on: ${{ github.event.inputs.platform == 'mac' && 'macos-latest' || 'ubuntu-latest' }}
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Pythonï¼ˆMac éœ€è¦ï¼‰
        if: github.event.inputs.platform == 'mac'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å‡†å¤‡çŽ¯å¢ƒ
        run: |
          echo "=========================================="
          echo "Agora SDK å¢žå¼ºæ‰“åŒ…"
          echo "=========================================="
          echo "SDK URL: ${{ github.event.inputs.sdk_url }}"
          echo "SDK Version: ${{ github.event.inputs.sdk_version }}"
          echo "Platform: ${{ github.event.inputs.platform }}"
          echo "=========================================="
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p build/original_sdk
          
          # æ£€æŸ¥é¢å¤–èµ„æº
          echo "æ£€æŸ¥é¢å¤–èµ„æº:"
          ls -la extra_resources/
      
      - name: ä¸‹è½½åŽŸå§‹ SDK
        run: |
          echo "ä¸‹è½½ SDK..."
          cd build
          curl -L -o original_sdk.zip "${{ github.event.inputs.sdk_url }}"
          
          if [ ! -f original_sdk.zip ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          echo "âœ“ ä¸‹è½½å®Œæˆ"
          ls -lh original_sdk.zip
      
      - name: è§£åŽ‹åŽŸå§‹ SDK
        run: |
          echo "è§£åŽ‹ SDK..."
          cd build
          unzip -q original_sdk.zip -d original_sdk
          
          echo "âœ“ è§£åŽ‹å®Œæˆ"
          ls -lh original_sdk/
      
      - name: å¤„ç† SDK (Linux)
        if: github.event.inputs.platform == 'linux'
        run: |
          echo "å¤„ç† Linux SDK..."
          ./scripts/process_sdk.sh \
            "${GITHUB_WORKSPACE}/build/original_sdk" \
            "${GITHUB_WORKSPACE}/extra_resources"
      
      - name: å¤„ç† SDK (Mac)
        if: github.event.inputs.platform == 'mac'
        run: |
          echo "å¤„ç† Mac SDK..."
          ./scripts/process_sdk_mac.sh \
            "${GITHUB_WORKSPACE}/build/original_sdk" \
            "${GITHUB_WORKSPACE}/extra_resources" \
            "${GITHUB_WORKSPACE}/scripts/framework_to_dylib.py"
      
      - name: æ‰“åŒ… SDK
        run: |
          echo "æ‰“åŒ… SDK..."
          ORIGINAL_SDK_NAME=$(basename "${{ github.event.inputs.sdk_url }}")
          echo "åŽŸå§‹ SDK åç§°: ${ORIGINAL_SDK_NAME}"
          
          if [ "${{ github.event.inputs.platform }}" = "linux" ]; then
            ./scripts/package_sdk.sh \
              "${GITHUB_WORKSPACE}/build/original_sdk" \
              "${ORIGINAL_SDK_NAME}"
          else
            ./scripts/package_sdk_mac.sh \
              "${GITHUB_WORKSPACE}/build/original_sdk" \
              "${ORIGINAL_SDK_NAME}"
          fi
          
          # ç§»åŠ¨ç”Ÿæˆçš„æ–‡ä»¶
          if [ "${{ github.event.inputs.platform }}" = "linux" ]; then
            mv ${GITHUB_WORKSPACE}/build/original_sdk/agora_rtc_sdk_*.zip* ${GITHUB_WORKSPACE}/build/ 2>/dev/null || true
          else
            mv ${GITHUB_WORKSPACE}/build/original_sdk/agora_sdk_mac_*.zip* ${GITHUB_WORKSPACE}/build/ 2>/dev/null || true
          fi
          
          echo "âœ“ æ‰“åŒ…å®Œæˆ"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -lh ${GITHUB_WORKSPACE}/build/*.zip*
      
      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          cd build
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„ ZIP æ–‡ä»¶
          if [ "${{ github.event.inputs.platform }}" = "linux" ]; then
            NEW_SDK_FILE=$(ls agora_rtc_sdk_*.zip 2>/dev/null | head -1)
          else
            NEW_SDK_FILE=$(ls agora_sdk_mac_*.zip 2>/dev/null | head -1)
          fi
          
          if [ -z "${NEW_SDK_FILE}" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„ SDK æ–‡ä»¶"
            exit 1
          fi
          
          # è¯»å– MD5
          MD5_VALUE=""
          if [ -f "${NEW_SDK_FILE}.md5" ]; then
            MD5_VALUE=$(cat "${NEW_SDK_FILE}.md5" | cut -d' ' -f1)
          fi
          
          # ç”ŸæˆæŠ¥å‘Š
          cat > build_report.txt <<EOF
          ==========================================
          Agora SDK å¢žå¼ºç‰ˆæœ¬æž„å»ºæŠ¥å‘Š
          ==========================================
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          GitHub Run: ${{ github.run_number }}
          Workflow: ${{ github.workflow }}
          
          SDK ä¿¡æ¯:
          - ç‰ˆæœ¬: ${{ github.event.inputs.sdk_version }}
          - å¹³å°: ${{ github.event.inputs.platform }}
          - åŽŸå§‹ SDK URL: ${{ github.event.inputs.sdk_url }}
          
          ç”Ÿæˆæ–‡ä»¶:
          - æ–‡ä»¶å: ${NEW_SDK_FILE}
          - æ–‡ä»¶å¤§å°: $(du -h ${NEW_SDK_FILE} | cut -f1)
          - MD5: ${MD5_VALUE}
          
          å¢žå¼ºå†…å®¹:
          EOF
          
          # æ ¹æ®å¹³å°æ·»åŠ å†…å®¹
          if [ "${{ github.event.inputs.platform }}" = "linux" ]; then
            cat >> build_report.txt <<EOF
          - åˆ é™¤æ–‡ä»¶:
            * libagora_mcc_ysd_extension.so
            * libagora_stt_ag_extension.so
            * libagora_stt_ms_extension.so
          - æ·»åŠ  RTM SDK åº“æ–‡ä»¶:
            * libagora_rtm_sdk_c.so
            * libagora_rtm_sdk.so
            * libagora_uap_aed.so
          - æ·»åŠ  RTM SDK å¤´æ–‡ä»¶ç›®å½•
          - æ·»åŠ  VAD å¤´æ–‡ä»¶
          - ç›®å½•é‡å‘½å: sdk -> agora_sdk
          EOF
          else
            cat >> build_report.txt <<EOF
          - xcframework è½¬æ¢ä¸º dylib
          - æ·»åŠ  RTM SDK åº“æ–‡ä»¶:
            * libagora_rtm_sdk_c.dylib
            * libAgoraRtmKit.dylib
            * libuap_aed.dylib
          - æ‰“åŒ…ä¸º agora_sdk ç›®å½•
          EOF
          fi
          
          cat >> build_report.txt <<EOF
          
          ==========================================
          EOF
          
          cat build_report.txt
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: sdk-${{ github.event.inputs.platform }}-${{ github.event.inputs.sdk_version }}
          path: |
            build/*.zip
            build/*.md5
            build/build_report.txt
          retention-days: 30
      
      - name: æž„å»ºæ€»ç»“
        run: |
          echo "=========================================="
          echo "âœ… SDK å¢žå¼ºæ‰“åŒ…æˆåŠŸï¼"
          echo "=========================================="
          echo "å¹³å°: ${{ github.event.inputs.platform }}"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.sdk_version }}"
          echo ""
          echo "ðŸ“¦ æž„å»ºäº§ç‰©å·²ä¸Šä¼ ï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
          echo "=========================================="

